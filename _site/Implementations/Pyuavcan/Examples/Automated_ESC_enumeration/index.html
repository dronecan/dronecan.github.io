<h1 id="automated-esc-enumeration">Automated ESC enumeration</h1>

<p>In this example we’ll demonstrate how the automated ESC enumeration feature works from the inside.
Please read the UAVCAN specification if the concept of automated enumeration is not familiar to you.</p>

<h2 id="writing-the-script">Writing the script</h2>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">uavcan</span><span class="o">,</span> <span class="nn">time</span>


<span class="c"># Waiting until new nodes stop appearing online.</span>
<span class="c"># That would mean that all nodes that are connected to the bus are now online and ready to work.</span>
<span class="k">def</span> <span class="nf">wait_for_all_nodes_to_become_online</span><span class="p">():</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">new_num_nodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dynamic_node_id_allocator</span><span class="o">.</span><span class="n">get_allocation_table</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">new_num_nodes</span> <span class="o">==</span> <span class="n">num_nodes</span> <span class="ow">and</span> <span class="n">num_nodes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">new_num_nodes</span>


<span class="c"># Determining how many ESC nodes are present.</span>
<span class="c"># In real use cases though the number of ESC should be obtained from elsewhere, e.g. from control mixer settings.</span>
<span class="c"># There is a helper class in PyUAVCAN that allows one to automate what we're doing here,</span>
<span class="c"># but we're not using it for the purposes of greater clarity of what's going on on the protocol level.</span>
<span class="k">def</span> <span class="nf">detect_esc_nodes</span><span class="p">():</span>
    <span class="n">esc_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">uavcan</span><span class="o">.</span><span class="n">equipment</span><span class="o">.</span><span class="n">esc</span><span class="o">.</span><span class="n">Status</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">event</span><span class="p">:</span> <span class="n">esc_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">source_node_id</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>            <span class="c"># Collecting ESC status messages, thus determining which nodes are ESC</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">esc_nodes</span>


<span class="c"># Enumerating ESC.</span>
<span class="c"># In this example we're using blocking code for simplicity reasons,</span>
<span class="c"># but real applications will most likely resort either to asynchronous code (callback-based),</span>
<span class="c"># or implement the logic in a dedicated thread.</span>
<span class="c"># Conversion of the code from synchronous to asynchronous/multithreaded pertains to the domain of general</span>
<span class="c"># programming issues, so these questions are not covered in this demo.</span>
<span class="k">def</span> <span class="nf">enumerate_all_esc</span><span class="p">(</span><span class="n">esc_nodes</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
    <span class="n">begin_responses_succeeded</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">begin_response_checker</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">nonlocal</span> <span class="n">begin_responses_succeeded</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Request timed out'</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">error</span> <span class="o">!=</span> <span class="n">event</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">ERROR_OK</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Enumeration rejected</span><span class="se">\n</span><span class="s">'</span> <span class="o">+</span> <span class="n">uavcan</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

        <span class="n">begin_responses_succeeded</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">overall_deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'Starting enumeration on all nodes...'</span><span class="p">)</span>
    <span class="n">begin_request</span> <span class="o">=</span> <span class="n">uavcan</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">enumeration</span><span class="o">.</span><span class="n">Begin</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">timeout_sec</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="n">esc_nodes</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Sending enumeration begin request to'</span><span class="p">,</span> <span class="n">node_id</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">begin_request</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">begin_response_checker</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">begin_responses_succeeded</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">esc_nodes</span><span class="p">):</span>
        <span class="n">node</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'Listening for indications...'</span><span class="p">)</span>
    <span class="n">enumerated_nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">next_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="nb">set</span><span class="p">(</span><span class="n">enumerated_nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="n">esc_nodes</span><span class="p">:</span>
        <span class="n">received_indication</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">def</span> <span class="nf">indication_callback</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">nonlocal</span> <span class="n">received_indication</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">source_node_id</span> <span class="ow">in</span> <span class="n">enumerated_nodes</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'Indication callback from node </span><span class="si">%</span><span class="s">d ignored - already enumerated'</span> <span class="o">%</span> <span class="n">event</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">source_node_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">uavcan</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
                <span class="n">received_indication</span> <span class="o">=</span> <span class="n">event</span>

        <span class="n">indication_handler</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">uavcan</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">enumeration</span><span class="o">.</span><span class="n">Indication</span><span class="p">,</span> <span class="n">indication_callback</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'=== PROVIDE ENUMERATION FEEDBACK ON ESC INDEX </span><span class="si">%</span><span class="s">d NOW ==='</span> <span class="o">%</span> <span class="n">next_index</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'=== e.g. turn the motor, press the button, etc, depending on your equipment ==='</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">received_indication</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">overall_deadline</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Process timed out'</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">indication_handler</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

        <span class="n">target_node_id</span> <span class="o">=</span> <span class="n">received_indication</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">source_node_id</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Indication received from node'</span><span class="p">,</span> <span class="n">target_node_id</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">'Stopping enumeration on node'</span><span class="p">,</span> <span class="n">target_node_id</span><span class="p">)</span>
        <span class="n">begin_responses_succeeded</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">node</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">uavcan</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">enumeration</span><span class="o">.</span><span class="n">Begin</span><span class="o">.</span><span class="n">Request</span><span class="p">(),</span> <span class="n">target_node_id</span><span class="p">,</span> <span class="n">begin_response_checker</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">begin_responses_succeeded</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">'Setting config param </span><span class="si">%</span><span class="s">r to </span><span class="si">%</span><span class="s">r...'</span> <span class="o">%</span> <span class="p">(</span><span class="n">received_indication</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">parameter_name</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">next_index</span><span class="p">))</span>
        <span class="n">configuration_finished</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">def</span> <span class="nf">param_set_response</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Request timed out'</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">event</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">received_indication</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">parameter_name</span>
            <span class="k">assert</span> <span class="n">event</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">integer_value</span> <span class="o">==</span> <span class="n">next_index</span>
            <span class="k">print</span><span class="p">(</span><span class="n">uavcan</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
            <span class="n">node</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">uavcan</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">ExecuteOpcode</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span>
                             <span class="n">opcode</span><span class="o">=</span><span class="n">uavcan</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">ExecuteOpcode</span><span class="o">.</span><span class="n">Request</span><span class="p">()</span><span class="o">.</span><span class="n">OPCODE_SAVE</span><span class="p">),</span>
                         <span class="n">target_node_id</span><span class="p">,</span>
                         <span class="n">param_opcode_response</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">param_opcode_response</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">nonlocal</span> <span class="n">configuration_finished</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Request timed out'</span><span class="p">)</span>

            <span class="k">print</span><span class="p">(</span><span class="n">uavcan</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Param opcode execution rejected</span><span class="se">\n</span><span class="s">'</span> <span class="o">+</span> <span class="n">uavcan</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">configuration_finished</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">node</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">uavcan</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">GetSet</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">uavcan</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">integer_value</span><span class="o">=</span><span class="n">next_index</span><span class="p">),</span>
                                                          <span class="n">name</span><span class="o">=</span><span class="n">received_indication</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">parameter_name</span><span class="p">),</span>
                     <span class="n">target_node_id</span><span class="p">,</span>
                     <span class="n">param_set_response</span><span class="p">)</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">configuration_finished</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">'Node'</span><span class="p">,</span> <span class="n">target_node_id</span><span class="p">,</span> <span class="s">'assigned ESC index'</span><span class="p">,</span> <span class="n">next_index</span><span class="p">)</span>
        <span class="n">next_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">enumerated_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target_node_id</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Enumerated so far:'</span><span class="p">,</span> <span class="n">enumerated_nodes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">enumerated_nodes</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="c"># Initializing a UAVCAN node instance.</span>
    <span class="c"># In this example we're using an SLCAN adapter on the port '/dev/ttyACM0'.</span>
    <span class="c"># PyUAVCAN also supports other types of adapters, refer to its docs to learn more.</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">uavcan</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s">'/dev/ttyACM0'</span><span class="p">,</span> <span class="n">node_id</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">bitrate</span><span class="o">=</span><span class="mi">1000000</span><span class="p">)</span>

    <span class="c"># Initializing a dynamic node ID allocator.</span>
    <span class="c"># This would not be necessary if the nodes were configured to use static node ID.</span>
    <span class="n">node_monitor</span> <span class="o">=</span> <span class="n">uavcan</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">node_monitor</span><span class="o">.</span><span class="n">NodeMonitor</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">dynamic_node_id_allocator</span> <span class="o">=</span> <span class="n">uavcan</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">dynamic_node_id</span><span class="o">.</span><span class="n">CentralizedServer</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node_monitor</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'Waiting for all nodes to appear online, this should take less than a minute...'</span><span class="p">)</span>
    <span class="n">wait_for_all_nodes_to_become_online</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Online nodes:'</span><span class="p">,</span> <span class="p">[</span><span class="n">node_id</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="n">dynamic_node_id_allocator</span><span class="o">.</span><span class="n">get_allocation_table</span><span class="p">()])</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'Detecting ESC nodes...'</span><span class="p">)</span>
    <span class="n">esc_nodes</span> <span class="o">=</span> <span class="n">detect_esc_nodes</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'ESC nodes:'</span><span class="p">,</span> <span class="n">esc_nodes</span><span class="p">)</span>

    <span class="n">enumerated_esc</span> <span class="o">=</span> <span class="n">enumerate_all_esc</span><span class="p">(</span><span class="n">esc_nodes</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'All ESC enumerated successfully; index order is as follows:'</span><span class="p">,</span> <span class="n">enumerated_esc</span><span class="p">)</span>

</code></pre>
</div>

<h2 id="running-the-code">Running the code</h2>

<p>Connect ESC to the CAN bus
(it’s better to use multiple ESC, otherwise the auto-enumeration procedure becomes rather pointless),
start the script, and follow its instructions.</p>

<p>For each ESC you will see the output similar to this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>=== PROVIDE ENUMERATION FEEDBACK ON ESC INDEX 0 NOW ===
=== e.g. turn the motor, press the button, etc, depending on your equipment ===
### Message from 124 to All  ts_mono=94836.894482  ts_real=1470647890.850445
value:
  empty:
    {}
parameter_name: 'esc_index' # [101, 115, 99, 95, 105, 110, 100, 101, 120]
Indication received from node 124
Stopping enumeration on node 124
Setting config param 'esc_index' to 0...
### Response from 124 to 10  ts_mono=94837.077415  ts_real=1470647891.033378
value:
  integer_value: 0
default_value:
  integer_value: 0
max_value:
  integer_value: 15
min_value:
  integer_value: 0
name: 'esc_index' # [101, 115, 99, 95, 105, 110, 100, 101, 120]
### Response from 124 to 10  ts_mono=94837.122424  ts_real=1470647891.078387
argument: 0
ok: true
Node 124 assigned ESC index 0
Enumerated so far: [124]
</code></pre>
</div>

<h2 id="a-relevant-video">A relevant video</h2>

<p>The following video demonstrates how the automated enumeration works on the user level.
Although it was not performed with the script shown in this example, the core principles remain the same.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/4nSa8tvpbgQ" frameborder="0" allowfullscreen=""></iframe>
